# Item84

# 프로그램의 동작을 스레드 스케쥴러에 기대지 말라

스레드 스케쥴링은 운영체제의 스레드 스케쥴러가 담당한다. 정상적인 os라면 거의 비슷하겠지만 구체적인 스케쥴링 정책은 os 마다 다르다. 정확성이나 성능이 스레드 스케쥴러에 따라 달라지는 프로그램이라면 다른 플랫폼에 이식하기 어렵다.

### 스레드 수를 줄이자

가장 좋은 방법은 실행 가능한 평균 스레드 수를 줄이는 것이다. 그래야 스레드 스케쥴러가 고민할 거리가 줄어든다. 실행 준비가 된 스레드들은 맡은 작업을 완료할 때ㄷ 까지 계속 실행되도록 만들자.

이런 프로그램은 스레드 스케쥴링 정책이 상이한 시스템에서도 동작이 크게 다르지 않다.

### 스레드 수를 적게 유지하는법

각 스레드가 작업을 완료한 후 대기하도록 한다. 스레드가 당장 처리할 작업이 없다면 실행되어서는 안된다.

스레드 풀 크기를 적절히 설정하고 작업은 짧게유지하자. 단, 너무 짧으면 오히려 성능이 떨어진다.

### busy waiting 상태가 되지 말자.

공유 객체의 상태가 바뀔때까지 쉬지 않고 검사해서는 안된다. 이걸 검사하는 상태가 busy waiting 인데, 무한루프를 돌면서 계속 검사중인 상태라고 이해하면 쉽다.

이 상태는 스케쥴러의 변덕에 추약하며, 프로세서에 큰 부담을 준다. 다른 유용한 작업이 실행될 기회를 박탈한다. 

### Thread.yield

특정 스레드가 다른 스레드와 비교하여 cpu 시간을  충분이 얻지 못하는것 같으면, Thread.yield를 사용할 수 있다. 증상이 어느정도 호전될 수 있지만 이식성은 그렇지 않다.  jvm마다 효과가 다를 수 있다.

스레드 우선순위를 조절할 수도 있지만 이식성이 나쁘다. 애초에 이 기능들은 스레드 스케쥴러에게 스케쥴링 힌트를 줄 뿐 직접적으로 제어하지 않는다. 이걸로 프로그램을 고치려고 하지말자.